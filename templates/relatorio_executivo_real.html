<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Executivo - An√°lise Financeira</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-dark: #101D43;
            --primary-gold: #D6BC71;
            --secondary-blue: #1a2d5a;
            --light-blue: #2a3d6a;
            --dark-gold: #c0a85f;
            --light-gold: #e8d9a8;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196f3;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-blue) 50%, var(--light-blue) 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, var(--primary-gold) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, var(--dark-gold) 0%, transparent 40%);
            opacity: 0.1;
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-top: 5px solid var(--primary-gold);
        }

        .header h1 {
            color: var(--primary-dark);
            margin-bottom: 10px;
            font-size: 32px;
            font-weight: 700;
        }

        .header-subtitle {
            color: #666;
            margin-top: 5px;
            font-size: 16px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-blue) 100%);
            color: white;
            border: 2px solid var(--primary-gold);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(214, 188, 113, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        /* Period Info */
        .period-info {
            background: linear-gradient(135deg, var(--light-gold) 0%, #fff 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-dark);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .period-info strong {
            color: var(--primary-dark);
            font-size: 16px;
        }

        /* Section Card */
        .section-card {
            background: white;
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border-top: 4px solid var(--primary-gold);
        }

        .section-title {
            color: var(--primary-dark);
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--light-gold);
        }

        .section-description {
            color: #666;
            font-size: 15px;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        /* Subsection */
        .subsection {
            background: linear-gradient(135deg, #fefdfb 0%, #faf8f3 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid var(--primary-gold);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .subsection:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(214, 188, 113, 0.2);
        }

        .subsection-title {
            color: var(--primary-dark);
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subsection-content {
            color: #444;
            font-size: 15px;
            line-height: 1.7;
        }

        /* Indicator Dots */
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .indicator-red {
            background: var(--danger);
        }

        .indicator-green {
            background: var(--success);
        }

        .indicator-yellow {
            background: var(--warning);
        }

        .indicator-blue {
            background: var(--info);
        }

        /* Event Cards (for Sum√°rio Executivo) */
        .event-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid var(--primary-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .event-card.positive {
            border-left-color: var(--success);
        }

        .event-card.negative {
            border-left-color: var(--danger);
        }

        .event-card.warning {
            border-left-color: var(--warning);
        }

        .event-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .event-description {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        /* SWOT Grid */
        .swot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .swot-box {
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .swot-box.for√ßas {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 5px solid var(--success);
        }

        .swot-box.fraquezas {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-left: 5px solid var(--danger);
        }

        .swot-box.oportunidades {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid var(--info);
        }

        .swot-box.amea√ßas {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 5px solid var(--warning);
        }

        .swot-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--primary-dark);
        }

        .swot-content {
            font-size: 14px;
            color: #444;
            line-height: 1.6;
        }

        /* Action Plan Cards */
        .action-cards {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .action-card {
            background: linear-gradient(135deg, #fefdfb 0%, #faf8f3 100%);
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid var(--primary-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .action-card.urgent {
            border-left-color: var(--danger);
            background: linear-gradient(135deg, #ffebee 0%, #fff 100%);
        }

        .action-card.important {
            border-left-color: var(--warning);
            background: linear-gradient(135deg, #fff3e0 0%, #fff 100%);
        }

        .action-card.monitor {
            border-left-color: var(--info);
            background: linear-gradient(135deg, #e3f2fd 0%, #fff 100%);
        }

        .action-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 12px;
        }

        .action-content {
            font-size: 15px;
            color: #444;
            line-height: 1.7;
        }

        /* Nested Subsections */
        .nested-subsection {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 3px solid var(--light-gold);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .nested-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--secondary-blue);
            margin-bottom: 10px;
        }

        .nested-content {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        /* Loader */
        .loader {
            border: 5px solid var(--light-gold);
            border-top: 5px solid var(--primary-gold);
            border-right: 5px solid var(--dark-gold);
            border-bottom: 5px solid var(--primary-dark);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .event-cards,
            .swot-grid {
                grid-template-columns: 1fr;
            }

            .section-card {
                padding: 20px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header-subtitle {
                font-size: 13px;
            }

            .header-actions {
                flex-direction: column;
                gap: 8px;
            }

            .btn {
                width: 100%;
                padding: 10px;
                font-size: 14px;
            }

            .section-title {
                font-size: 22px;
            }

            .subsection-title {
                font-size: 16px;
            }

            /* Logo menor em mobile */
            body > div:first-child {
                top: 5px;
                left: 5px;
            }

            body > div:first-child img {
                height: 20px !important;
            }

            .container {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }

            .section-title {
                font-size: 20px;
            }

            .section-card {
                padding: 15px;
            }
        }

        @media print {
            body {
                background: white;
            }
            .header-actions, .btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Logo no canto superior esquerdo -->
    <div style="position: fixed; top: 8px; left: 10px; z-index: 1000;">
        <img src="/static/TAG_BSS_OFICIAL.png" alt="TAG BSS Logo" style="height: 25px; width: auto;">
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìä Relat√≥rio Executivo de An√°lise Financeira</h1>
            <p class="header-subtitle">An√°lise detalhada com insights estrat√©gicos baseados com dados dos arquivos OFX</p>
            <div class="header-actions">
                <a href="/results" class="btn btn-secondary">‚¨ÖÔ∏è Voltar aos Resultados</a>
                <a href="/" class="btn btn-secondary">üè† In√≠cio</a>
                <button class="btn btn-success" onclick="downloadPDF()">üì• Baixar PDF Executivo</button>
            </div>
        </div>

        <!-- Banner de Dados Reais -->
        <!-- <div style="background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; font-weight: bold; box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px;">
            ‚úÖ Este relat√≥rio utiliza APENAS dados REAIS extra√≠dos dos seus arquivos OFX
        </div> -->

        <!-- Loader -->
        <div id="loader" class="loader"></div>

        <!-- Content -->
        <div id="content" style="display: none;">
            
            <!-- 1. SUM√ÅRIO EXECUTIVO -->
            <div class="section-card">
                <h2 class="section-title">
                    üìå Sum√°rio Executivo
                </h2>
                <p class="section-description">
                    Os eventos mais relevantes identificados pela an√°lise dos dados financeiros.
                </p>
                
                <div class="event-cards" id="key-events">
                    <!-- Eventos ser√£o carregados dinamicamente -->
                </div>
            </div>

            <!-- 2. MAPA DE RECEITA -->
            <div class="section-card">
                <h2 class="section-title">
                    üí∞ Mapa de Receitas
                </h2>
                <p class="section-description">
                    An√°lise detalhada da evolu√ß√£o das receitas com comparativos mensais, anuais e diagn√≥stico de sazonalidade.
                </p>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Mensal (m√™s vs m√™s anterior)
                    </h3>
                    <p class="subsection-content" id="revenue-monthly">
                        Carregando an√°lise mensal baseada em dados reais...
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Anual (m√™s vs mesmo m√™s no ano anterior)
                    </h3>
                    <p class="subsection-content" id="revenue-annual">
                        N√£o h√° dados de outros anos para compara√ß√£o ‚Äî an√°lise anual indispon√≠vel.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        An√°lise de Sazonalidade
                    </h3>
                    <p class="subsection-content" id="revenue-seasonal">
                        Dados insuficientes para an√°lise de sazonalidade.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-green"></span>
                        Diagn√≥stico
                    </h3>
                    <p class="subsection-content" id="revenue-diagnosis">
                        Diagn√≥stico baseado em dados reais ser√° exibido aqui quando dispon√≠vel.
                    </p>
                </div>
            </div>

            <!-- 3. MAPA DE CUSTOS -->
            <div class="section-card">
                <h2 class="section-title">
                    üì¶ Mapa de Custos
                </h2>
                <p class="section-description">
                    An√°lise dos custos diretos relacionados √† produ√ß√£o e opera√ß√£o do neg√≥cio.
                </p>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Mensal (m√™s vs m√™s anterior)
                    </h3>
                    <p class="subsection-content" id="costs-monthly">
                        Carregando an√°lise mensal de custos baseada em dados reais...
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Anual (m√™s vs mesmo m√™s no ano anterior)
                    </h3>
                    <p class="subsection-content" id="costs-annual">
                        N√£o h√° dados de outros anos para compara√ß√£o ‚Äî an√°lise anual indispon√≠vel.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        An√°lise de Sazonalidade
                    </h3>
                    <p class="subsection-content" id="costs-seasonal">
                        Dados insuficientes para an√°lise de sazonalidade de custos.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-yellow"></span>
                        Diagn√≥stico
                    </h3>
                    <p class="subsection-content" id="costs-diagnosis">
                        Diagn√≥stico de custos baseado em dados reais ser√° exibido aqui quando poss√≠vel.
                    </p>
                </div>
            </div>

            <!-- 4. MAPA DE DESPESAS -->
            <div class="section-card">
                <h2 class="section-title">
                    üí∏ Mapa de Despesas
                </h2>
                <p class="section-description">
                    An√°lise detalhada das despesas operacionais, administrativas e comerciais da empresa.
                </p>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Mensal (m√™s vs m√™s anterior)
                    </h3>
                    <p class="subsection-content" id="expenses-monthly">
                        Carregando an√°lise mensal de despesas baseada em dados reais...
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Anual (m√™s vs mesmo m√™s no ano anterior)
                    </h3>
                    <p class="subsection-content" id="expenses-annual">
                        N√£o h√° dados de outros anos para compara√ß√£o ‚Äî an√°lise anual indispon√≠vel.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        An√°lise de Sazonalidade
                    </h3>
                    <p class="subsection-content" id="expenses-seasonal">
                        Dados insuficientes para an√°lise de sazonalidade de despesas.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-green"></span>
                        Diagn√≥stico
                    </h3>
                    <p class="subsection-content" id="expenses-diagnosis">
                        Diagn√≥stico de despesas baseado em dados reais ser√° exibido aqui quando poss√≠vel.
                    </p>
                </div>
            </div>

            <!-- 5. DEPRECIA√á√ÉO & AMORTIZA√á√ÉO -->
            <div class="section-card">
                <h2 class="section-title">
                    üìâ Deprecia√ß√£o & Amortiza√ß√£o
                </h2>
                <p class="section-description">
                    Avalia√ß√£o cont√°bil e financeira dos impactos da deprecia√ß√£o e amortiza√ß√£o no resultado.
                </p>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Controle Cont√°bil
                    </h3>
                    <p class="subsection-content" id="depreciation-control">
                        Os arquivos OFX n√£o trazem informa√ß√µes de deprecia√ß√£o/amortiza√ß√£o. Este relat√≥rio n√£o estima valores n√£o dispon√≠veis.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-green"></span>
                        Impacto no Resultado
                    </h3>
                    <p class="subsection-content" id="depreciation-impact">
                        Sem dados de deprecia√ß√£o no OFX, n√£o √© poss√≠vel calcular impacto no resultado por este relat√≥rio.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Boas Pr√°ticas
                    </h3>
                    <p class="subsection-content">
                        Boas pr√°ticas de gest√£o patrimonial podem ser avaliadas fora deste relat√≥rio. Aqui usamos exclusivamente dados dos extratos.
                    </p>
                </div>
            </div>

            <!-- 6. TRIBUTOS -->
            <div class="section-card">
                <h2 class="section-title">
                    üèõÔ∏è Tributos
                </h2>
                <p class="section-description">
                    An√°lise do impacto tribut√°rio no m√™s e oportunidades de otimiza√ß√£o fiscal.
                </p>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        An√°lise Interna
                    </h3>
                    <p class="subsection-content" id="taxes-internal">
                        Os extratos OFX n√£o detalham a apura√ß√£o tribut√°ria. N√£o apresentamos valores de tributos aqui.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-green"></span>
                        An√°lise Externa
                    </h3>
                    <p class="subsection-content">
                        Para recomenda√ß√µes tribut√°rias, utilize an√°lises espec√≠ficas fora deste relat√≥rio. Aqui mantemos apenas informa√ß√µes provenientes dos dados OFX.
                    </p>
                </div>
            </div>

            <!-- 7. FLUXO DE CAIXA -->
            <div class="section-card">
                <h2 class="section-title">
                    üíµ Mapa do Fluxo de Caixa
                </h2>
                <p class="section-description">
                    An√°lises do fluxo operacional, de financiamento e movimenta√ß√£o entre contas.
                </p>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Mensal (m√™s vs m√™s anterior)
                    </h3>
                    <p class="subsection-content" id="dfc-monthly">
                        Dados insuficientes para compara√ß√£o mensal do fluxo de caixa.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        Anual (m√™s vs mesmo m√™s no ano anterior)
                    </h3>
                    <p class="subsection-content" id="dfc-annual">
                        N√£o h√° dados de outros anos para compara√ß√£o ‚Äî an√°lise anual indispon√≠vel para fluxo de caixa.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-blue"></span>
                        An√°lise de Sazonalidade
                    </h3>
                    <p class="subsection-content" id="dfc-seasonal">
                        Dados insuficientes para an√°lise de sazonalidade do fluxo de caixa.
                    </p>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">
                        <span class="indicator indicator-green"></span>
                        Diagn√≥stico
                    </h3>
                    <p class="subsection-content" id="dfc-summary">
                        Resumo do fluxo de caixa com base nos dados OFX ser√° exibido aqui quando dispon√≠vel.
                    </p>
                </div>
            </div>

            <!-- 8. PARECER DA TAG (Recomenda√ß√µes Executivas) -->
            <div class="section-card">
                <h2 class="section-title">
                    üéØ Parecer da TAG
                </h2>
                <p class="section-description">
                    An√°lise SWOT, alertas e pontos de aten√ß√£o considerando n√∫meros do m√™s, fundamentos de neg√≥cios e segmento.
                </p>

                <!-- SWOT Analysis -->
                <h3 class="subsection-title" style="margin-top: 20px; margin-bottom: 15px;">
                    <span class="indicator indicator-blue"></span>
                    An√°lise SWOT
                </h3>
                
                <div class="swot-grid" id="swot-grid">
                    <div class="swot-box for√ßas">
                        <div class="swot-title">üí™ For√ßas</div>
                        <ul class="swot-content" id="swot-forcas"></ul>
                    </div>

                    <div class="swot-box fraquezas">
                        <div class="swot-title">‚ö†Ô∏è Fraquezas</div>
                        <ul class="swot-content" id="swot-fraquezas"></ul>
                    </div>

                    <div class="swot-box oportunidades">
                        <div class="swot-title">üåü Oportunidades</div>
                        <ul class="swot-content" id="swot-oportunidades"></ul>
                    </div>

                    <div class="swot-box amea√ßas">
                        <div class="swot-title">‚ö° Amea√ßas</div>
                        <ul class="swot-content" id="swot-ameacas"></ul>
                    </div>
                </div>

                <!-- Action Plans -->
                <h3 class="subsection-title" style="margin-top: 30px; margin-bottom: 15px;">
                    <span class="indicator indicator-red"></span>
                    Planos de A√ß√£o
                </h3>

                <div class="action-cards" id="action-plans">
                    <!-- Planos de a√ß√£o ser√£o carregados dinamicamente -->
                </div>
            </div>

        </div>
    </div>

    <script>
        window.onload = async () => {
            try {
                const resp = await fetch('/api/relatorio');
                const data = await resp.json();

                // Mostrar conte√∫do
                document.getElementById('loader').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                // ========== EVENTOS-CHAVE ==========
                const keyEventsContainer = document.getElementById('key-events');
                const keyEvents = data?.strategic_report?.key_events || [];
                if (keyEvents.length > 0) {
                    keyEventsContainer.innerHTML = '';
                    keyEvents.forEach(event => {
                        const tipo = String(event.tipo || '').toUpperCase();
                        const cardClass = tipo.includes('POSITIVO') ? 'positive' :
                                         tipo.includes('NEGATIVO') ? 'negative' : 'warning';
                        const indicatorClass = tipo.includes('POSITIVO') ? 'indicator-green' :
                                              tipo.includes('NEGATIVO') ? 'indicator-red' : 'indicator-yellow';
                        keyEventsContainer.innerHTML += `
                            <div class="event-card ${cardClass}">
                                <div class="event-title">
                                    <span class="indicator ${indicatorClass}"></span>
                                    ${event.titulo || 'Evento'}
                                </div>
                                <p class="event-description">${event.descricao || ''}</p>
                            </div>`;
                    });
                } else {
                    keyEventsContainer.innerHTML = `
                        <div class="event-card">
                            <div class="event-title">
                                <span class="indicator indicator-blue"></span>
                                An√°lise de Eventos
                            </div>
                            <p class="event-description">Sem eventos destacados at√© o momento.</p>
                        </div>`;
                }

                // Helpers
                const getYearsFromComparacoes = (lista, fallbackLista) => {
                    const years = new Set();
                    const fonte = Array.isArray(lista) && lista.length ? lista : (Array.isArray(fallbackLista) ? fallbackLista : []);
                    fonte.forEach(item => {
                        const mes = item?.mes || item?.period_a?.mes || item?.period_b?.mes || '';
                        const match = String(mes).match(/(19|20)\d{2}/);
                        if (match) years.add(match[0]);
                    });
                    return years;
                };

                // ========== RECEITA (MENSAL) ==========
                const revenueMonthlyElement = document.getElementById('revenue-monthly');
                if (Array.isArray(data?.tendencia_mensal) && data.tendencia_mensal.length >= 2) {
                    const tendencia = data.tendencia_mensal;
                    const mes1 = tendencia[tendencia.length - 2];
                    const mes2 = tendencia[tendencia.length - 1];
                    const receita1 = Number(mes1?.receita ?? 0) || 0;
                    const receita2 = Number(mes2?.receita ?? 0) || 0;
                    let variacaoTxt = 'sem base de compara√ß√£o';
                    if (Math.abs(receita1) > 0) {
                        const variacao = ((receita2 - receita1) / Math.abs(receita1)) * 100;
                        variacaoTxt = `${variacao >= 0 ? '+' : ''}${variacao.toFixed(1)}%`;
                    }
                    const label = (s) => (typeof s === 'string' && s.includes('-')) ? `${s.split('-')[1]}/${s.split('-')[0]}` : (s || 'M√™s');
                    revenueMonthlyElement.textContent = `Baseado nos dados reais (OFX): ${label(mes1.mes)} = ${receita1.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})} | ${label(mes2.mes)} = ${receita2.toLocaleString('pt-BR', {style:'currency', currency:'BRL'})}. Varia√ß√£o: ${variacaoTxt}.`;
                } else {
                    revenueMonthlyElement.textContent = 'Dados insuficientes nos arquivos OFX para an√°lise mensal comparativa de receitas.';
                }

                // ========== RECEITA (ANUAL) ==========
                const years = getYearsFromComparacoes(data?.comparacoes_mensais, data?.tendencia_mensal);
                const revenueAnnualEl = document.getElementById('revenue-annual');
                const revenueAnalysis = data?.strategic_report?.revenue_analysis;
                if (revenueAnnualEl) {
                    if (years.size < 2) {
                        revenueAnnualEl.textContent = 'N√£o h√° dados de outros anos para compara√ß√£o ‚Äî an√°lise anual indispon√≠vel.';
                    } else {
                        revenueAnnualEl.textContent = 'An√°lise anual em processamento.';
                    }
                }

                // ========== SAZONALIDADE ==========
                const revenueSeasonalEl = document.getElementById('revenue-seasonal');
                if (revenueSeasonalEl) {
                    if (!Array.isArray(data?.comparacoes_mensais) || data.comparacoes_mensais.length < 6) {
                        revenueSeasonalEl.textContent = 'Dados insuficientes para an√°lise de sazonalidade.';
                    } else {
                        revenueSeasonalEl.textContent = 'An√°lise de sazonalidade em processamento.';
                    }
                }

                // ========== ANUAL (CUSTOS/DESPESAS) placeholders ==========
                const costsAnnualEl = document.getElementById('costs-annual');
                if (costsAnnualEl && years.size < 2) {
                    costsAnnualEl.textContent = 'N√£o h√° dados de outros anos para compara√ß√£o ‚Äî an√°lise anual indispon√≠vel.';
                }
                const expensesAnnualEl = document.getElementById('expenses-annual');
                if (expensesAnnualEl && years.size < 2) {
                    expensesAnnualEl.textContent = 'N√£o h√° dados de outros anos para compara√ß√£o ‚Äî an√°lise anual indispon√≠vel.';
                }

                // ========== CUSTOS e DESPESAS (MENSAL) ==========
                const tendencia = Array.isArray(data?.tendencia_mensal) ? data.tendencia_mensal : [];
                if (tendencia.length >= 2) {
                    const a = tendencia[tendencia.length - 2];
                    const b = tendencia[tendencia.length - 1];
                    const label = (s) => (typeof s === 'string' && s.includes('-')) ? `${s.split('-')[1]}/${s.split('-')[0]}` : (s || 'M√™s');

                    // Custos (usaremos 'despesa' como proxy de custos diretos se n√£o houver separa√ß√£o)
                    const custo1 = Number(a?.despesa ?? 0) || 0;
                    const custo2 = Number(b?.despesa ?? 0) || 0;
                    let varCustos = 'sem base de compara√ß√£o';
                    if (Math.abs(custo1) > 0) {
                        const v = ((custo2 - custo1) / custo1) * 100;
                        varCustos = `${v >= 0 ? '+' : ''}${v.toFixed(1)}%`;
                    }
                    const costsMonthlyEl = document.getElementById('costs-monthly');
                    if (costsMonthlyEl) {
                        costsMonthlyEl.textContent = `${label(a.mes)}: ${custo1.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} ‚Üí ${label(b.mes)}: ${custo2.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}. Varia√ß√£o: ${varCustos}.`;
                    }

                    // Despesas (idem)
                    const desp1 = Number(a?.despesa ?? 0) || 0;
                    const desp2 = Number(b?.despesa ?? 0) || 0;
                    let varDesp = 'sem base de compara√ß√£o';
                    if (Math.abs(desp1) > 0) {
                        const v2 = ((desp2 - desp1) / desp1) * 100;
                        varDesp = `${v2 >= 0 ? '+' : ''}${v2.toFixed(1)}%`;
                    }
                    const expensesMonthlyEl = document.getElementById('expenses-monthly');
                    if (expensesMonthlyEl) {
                        expensesMonthlyEl.textContent = `${label(a.mes)}: ${desp1.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})} ‚Üí ${label(b.mes)}: ${desp2.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}. Varia√ß√£o: ${varDesp}.`;
                    }
                    // Diagn√≥sticos simples baseados na varia√ß√£o
                    const costsDiagEl = document.getElementById('costs-diagnosis');
                    if (costsDiagEl) {
                        costsDiagEl.textContent = `Com base nos dados reais, os custos variaram ${varCustos} entre ${label(a.mes)} e ${label(b.mes)}.`;
                    }
                    const expensesDiagEl = document.getElementById('expenses-diagnosis');
                    if (expensesDiagEl) {
                        expensesDiagEl.textContent = `Com base nos dados reais, as despesas variaram ${varDesp} entre ${label(a.mes)} e ${label(b.mes)}.`;
                    }
                } else {
                    const costsMonthlyEl = document.getElementById('costs-monthly');
                    if (costsMonthlyEl) costsMonthlyEl.textContent = 'Dados insuficientes para an√°lise mensal de custos.';
                    const expensesMonthlyEl = document.getElementById('expenses-monthly');
                    if (expensesMonthlyEl) expensesMonthlyEl.textContent = 'Dados insuficientes para an√°lise mensal de despesas.';
                    const costsDiagEl = document.getElementById('costs-diagnosis');
                    if (costsDiagEl) costsDiagEl.textContent = 'Sem dados suficientes para diagn√≥stico de custos.';
                    const expensesDiagEl = document.getElementById('expenses-diagnosis');
                    if (expensesDiagEl) expensesDiagEl.textContent = 'Sem dados suficientes para diagn√≥stico de despesas.';
                }

                // ========== RECEITA (DIAGN√ìSTICO) ==========
                const revenueDiagnosisEl = document.getElementById('revenue-diagnosis');
                const revenueAnalysisFull = data?.strategic_report?.revenue_analysis?.analise_completa;
                if (revenueDiagnosisEl) {
                    if (typeof revenueAnalysisFull === 'string' && revenueAnalysisFull.trim()) {
                        revenueDiagnosisEl.textContent = revenueAnalysisFull.trim();
                    } else {
                        revenueDiagnosisEl.textContent = 'Sem diagn√≥stico consolidado de receitas no momento.';
                    }
                }

                // ========== SWOT DIN√ÇMICO ==========
                const swot = data?.strategic_report?.swot;
                const listOrFallback = (arr, el) => {
                    if (!el) return;
                    if (Array.isArray(arr) && arr.length) {
                        el.innerHTML = arr.map(item => `<li>${item}</li>`).join('');
                    } else {
                        el.innerHTML = '<li>Nenhum item dispon√≠vel com os dados atuais.</li>';
                    }
                };
                listOrFallback(swot?.forcas, document.getElementById('swot-forcas'));
                listOrFallback(swot?.fraquezas, document.getElementById('swot-fraquezas'));
                listOrFallback(swot?.oportunidades, document.getElementById('swot-oportunidades'));
                listOrFallback(swot?.ameacas, document.getElementById('swot-ameacas'));

                // ========== PLANOS DE A√á√ÉO DIN√ÇMICOS ==========
                const plansContainer = document.getElementById('action-plans');
                const plans = data?.strategic_report?.action_plans || [];
                if (plansContainer) {
                    if (Array.isArray(plans) && plans.length) {
                        plansContainer.innerHTML = '';
                        plans.forEach(p => {
                            const pr = String(p.prioridade || '').toUpperCase();
                            const cls = pr.includes('URGENTE') ? 'urgent' : pr.includes('IMPORTANTE') ? 'important' : 'monitor';
                            const acoes = Array.isArray(p.acoes) ? p.acoes.map(a => `‚Ä¢ ${a}`).join('<br>') : '';
                            plansContainer.innerHTML += `
                                <div class="action-card ${cls}">
                                    <div class="action-title">${p.titulo || 'Plano de A√ß√£o'}</div>
                                    <p class="action-content">
                                        <strong>Situa√ß√£o:</strong> ${p.situacao || '‚Äî'}<br><br>
                                        <strong>Impacto:</strong> ${p.impacto || '‚Äî'}<br><br>
                                        <strong>A√ß√µes:</strong><br>${acoes}
                                    </p>
                                </div>`;
                        });
                    } else {
                        plansContainer.innerHTML = '<div class="action-card"><div class="action-title">Sem planos de a√ß√£o</div><p class="action-content">Nenhuma recomenda√ß√£o foi gerada com os dados atuais.</p></div>';
                    }
                }

                // ========== FLUXO DE CAIXA (RESUMO) ==========
                const dfc = data?.dfc;
                const dfcSummaryEl = document.getElementById('dfc-summary');
                if (dfc && dfcSummaryEl) {
                    const op = Number(dfc.operacional ?? 0) || 0;
                    const inv = Number(dfc.investimento ?? 0) || 0;
                    const fin = Number(dfc.financiamento ?? 0) || 0;
                    const trf = Number(dfc.transferencias ?? 0) || 0;
                    dfcSummaryEl.textContent = `Operacional: ${op.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}; Investimento: ${inv.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}; Financiamento: ${fin.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}; Transfer√™ncias: ${trf.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}.`;
                }

            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                alert('ERRO: ' + error.message + '\n\nVeja o console (F12) para mais detalhes.');
                document.getElementById('loader').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                const revEl = document.getElementById('revenue-monthly');
                if (revEl) revEl.textContent = 'Erro ao carregar an√°lise de receitas.';
            }
        };

        function downloadPDF() {
            // Redirecionar para endpoint de download do PDF
            window.open('/relatorio/download', '_blank');
        }
    </script>
</body>
</html>
